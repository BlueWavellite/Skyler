<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Skyler, I Wish to Breathe Another Season – PDF Viewer</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

<style>
  body {
    margin:0;
    font-family:'Roboto Slab', serif;
    background:#0d2a3a;
    color:#fff;
    display:flex;
    flex-direction:column;
    height:100vh;
    overflow:hidden;
  }

  .toolbar {
    display:flex;
    align-items:center;
    gap:10px;
    background:#082133;
    padding:8px 16px;
    position:sticky;
    top:0;
    z-index:10;
    flex-shrink:0;
  }

  .toolbar button,
  .toolbar input {
    background-color:#eee;
    border:none;
    padding:6px 10px;
    border-radius:4px;
    cursor:pointer;
    color:#0d2a3a;
    font-weight:600;
  }

  #pdf-container-wrapper {
    flex:1;
    overflow-y:auto;
    position:relative;
  }

  #pdf-container {
    padding:18px;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:14px;
    transform-origin:top center;
  }

  canvas {
    box-shadow:0 0 8px rgba(0,0,0,0.5);
    border-radius:4px;
    display:block;
  }
</style>
</head>
<body>

<div class="toolbar">
  <button id="closeBtn">Close</button>

  <button id="zoomOut">−</button>
  <span>Zoom</span>
  <button id="zoomIn">+</button>

  <span>Page:</span>
  <input type="number" id="pageNumber" value="1" min="1">
  <span id="pageCount">/ ?</span>
</div>

<div id="pdf-container-wrapper">
  <div id="pdf-container"></div>
</div>

<script>
  const urlParams = new URLSearchParams(window.location.search);
  const pdfUrl = urlParams.get("file");
  if (!pdfUrl) { alert("PDF file not specified!"); throw new Error("No PDF file provided"); }

  const pdfWrapper = document.getElementById("pdf-container");
  const pageNumInput = document.getElementById("pageNumber");
  const pageCountSpan = document.getElementById("pageCount");

  let pdfDoc = null;
  let pages = [];
  let zoom = 1.2;  // real PDF.js zoom (not CSS)
  let isRendering = false;

  pdfjsLib.GlobalWorkerOptions.workerSrc =
    "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";

  pdfjsLib.getDocument(pdfUrl).promise.then((pdf) => {
    pdfDoc = pdf;
    pageCountSpan.textContent = "/ " + pdf.numPages;
    renderAllPages();
  });

  // Render all pages at CURRENT zoom
  function renderAllPages() {
    pdfWrapper.innerHTML = "";
    pages = [];

    for (let i = 1; i <= pdfDoc.numPages; i++) {
      let container = document.createElement("div");
      container.style.position = "relative";

      let canvas = document.createElement("canvas");
      canvas.dataset.page = i;

      container.appendChild(canvas);
      pdfWrapper.appendChild(container);

      pages.push(canvas);
      renderPage(i);
    }
  }

  // Render single page
  function renderPage(pageNum) {
    pdfDoc.getPage(pageNum).then(page => {
      const viewport = page.getViewport({ scale: zoom });

      const canvas = pages[pageNum - 1];
      const ctx = canvas.getContext("2d");

      const dpr = window.devicePixelRatio || 1;

      // High-resolution crisp text
      canvas.width = viewport.width * dpr;
      canvas.height = viewport.height * dpr;

      canvas.style.width = viewport.width + "px";
      canvas.style.height = viewport.height + "px";

      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

      page.render({ canvasContext: ctx, viewport });
    });
  }

  // Scroll → update page number
  document.getElementById("pdf-container").addEventListener("scroll", () => {
    const centerY = pdfWrapper.scrollTop + pdfWrapper.clientHeight / 2;

    let currentPage = 1;
    for (let i = 0; i < pages.length; i++) {
      const c = pages[i];
      const top = c.offsetTop;
      const bottom = top + c.clientHeight;

      if (top <= centerY && bottom >= centerY) {
        currentPage = i + 1;
        break;
      }
    }
    pageNumInput.value = currentPage;
  });

  // Jump to page
  pageNumInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      const p = Number(pageNumInput.value);
      if (p >= 1 && p <= pdfDoc.numPages) {
        pages[p - 1].scrollIntoView({ behavior: "smooth" });
      }
    }
  });

  // Zoom controls (real PDF zoom)
  document.getElementById("zoomIn").onclick = () => {
    zoom += 0.15;
    renderAllPages(); // accurate re-render
  };

  document.getElementById("zoomOut").onclick = () => {
    if (zoom > 0.4) {
      zoom -= 0.15;
      renderAllPages();
    }
  };

  // Close
  document.getElementById("closeBtn").onclick = () => window.close();
</script>


</body>
</html>
